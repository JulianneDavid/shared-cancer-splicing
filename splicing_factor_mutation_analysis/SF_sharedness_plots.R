#!/usr/bin/env/R

# SF_sharedness_plots.R
# plots jxn sharedness for patients with splicing factor mutations vs. expected sharedness across the cancer cohort
# uses shared_jxn_df.txt generated by running SF_mutation_script.R
# Code author: Ben Weeder
# Contact: weeder@ohsu.edu

# load in required libraries
require(data.table)
require(ggplot2)
require(gridExtra)
require(RColorBrewer)
require(tidyverse)
require(dplyr)

# load in data (shared_jxn_df.txt generated by updated-SF-script.R)
shared_jxns <- read.table("shared_jxn_df.txt", sep = "\t", header = T, stringsAsFactors = F)

## calculate sharedness for each junction
# note that plt_group is splicing factor status + cancer type for each patient based on UniProt
# note that plt_est_group is as above, but with splicing factor status based on Kahles et al.
shared_jxns <- subset(shared_jxns, !is.na(shared_jxns$plt_group) & !is.na(shared_jxns$plt_est_group))

# make list of cancer types
disease_list <- unique(shared_jxns$Disease)

# set up data frame
jxn_plot_df <- data.frame(jx_id=NULL, 
                          sharedness=NULL, 
                          OR_all=NULL, 
                          pval_all = NULL,
                          OR_est = NULL,
                          pval_est = NULL,
                          Disease=NULL)

# loop through each cancer and calculate sharedness within SF group vs. across cancer
for (dis in disease_list){
  # subset by cancer
  cancer_dat <- subset(shared_jxns, shared_jxns$Disease == dis)
  # look only at non-unique junctions (excludes 1 offs within cancer type)
  cancer_dat <- cancer_dat[which(cancer_dat$jx %in% cancer_dat$jx[duplicated(cancer_dat$jx)]),]
  cancer_dat$jx <- as.factor(cancer_dat$jx)
  
  cancer_vals <- cbind(table(cancer_dat$jx), rep(uniqueN(cancer_dat$tcga_id), length(unique(cancer_dat$jx))))
  
  # subset based on the two different SF status criteria
  all_df <- subset(cancer_dat, grepl("yes", cancer_dat$plt_group))
  est_df <- subset(cancer_dat, grepl("yes", cancer_dat$plt_est_group))
  
  # calculate shared N vs. total N
  all_vals <- cbind(table(all_df$jx), rep(uniqueN(all_df$tcga_id), length(unique(cancer_dat$jx))))
  est_vals <- cbind(table(est_df$jx), rep(uniqueN(est_df$tcga_id), length(unique(cancer_dat$jx))))
  
  # perform sig. test (fisher)
  all_tests <- apply(cbind(all_vals, cancer_vals), 1, function(x){
    test <- fisher.test(matrix(x, ncol = 2))
    return(list(test$estimate, test$p.value))})
  all_tests <- rbindlist(all_tests)
  
  est_tests <- apply(cbind(est_vals, cancer_vals), 1, function(x){
    test <- fisher.test(matrix(x, ncol = 2))
    return(list(test$estimate, test$p.value))})
  est_tests <- rbindlist(est_tests)
  
  # aggregate data for specific cancer type
  tmp_plt_df <- data.frame(jx_id = names(table(cancer_dat$jx)), 
                           sharedness = as.numeric(cancer_vals[,1]/cancer_vals[,2]), 
                           OR_all = as.numeric(all_tests$V1), 
                           pval_all = p.adjust(as.numeric(all_tests$V2), method = "fdr"),
                           OR_est = as.numeric(est_tests$V1),
                           pval_est = p.adjust(as.numeric(est_tests$V2), method = "fdr"),
                           Disease=dis)
  
  # add specific cancer data to full DF
  jxn_plot_df <- rbind(jxn_plot_df, tmp_plt_df)
  print(paste(dis, "Completed"))
}

# plot sharedness by cancer for UniProt based SF classification
p1 <- ggplot(jxn_plot_df, aes(x=log(OR_all), y=sharedness*100, color= pval_all < 05))+
  geom_point(alpha = .6)+
  geom_vline(xintercept = 0, lty = 3)+
  scale_color_manual(values = c("black", "red"))+
  theme_classic()+
  guides(color=F)+
  xlim(c(-4.5,4.5))+
  ylab("Cancer Wide Junction sharedness(%)")+
  xlab("Observed vs. Expected Junction Sharedness (log(OR)) For Those With at Least One Splicing Associated Gene Mutation")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"))
  
p1_grid <- p1 +facet_wrap(~Disease, ncol = 4)
ggsave(filename = "fig_s1h.pdf", plot = p1_grid, device = "pdf", width = 178, height = 178, units = "mm")


# plot sharedness by cancer for Kahles et al. prev. identified classification
p2 <- ggplot(jxn_plot_df, aes(x=log(OR_est), y=sharedness*100, color= pval_est < .05))+
  geom_point(alpha = .6)+
  geom_vline(xintercept = 0, lty = 3)+
  scale_color_manual(values = c("black", "red"))+
  theme_classic()+
  guides(color=F)+
  xlim(c(-4.5,4.5))+
  ylab("Cancer Wide Junction sharedness(%)")+
  xlab("Observed vs. Expected Junction Sharedness (log(OR)) For Those With At Least One Pre-Identified Splicing Related Gene Mutation")+
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"))

p2_grid <- p2 +facet_wrap(~Disease, ncol = 4)

ggsave(filename = "fig_s1i.pdf", plot = p2_grid, device = "pdf", width = 178, height = 178, units = "in")

# print out list of junctions with FDR < 0.1
# jxn_plot_df[which(jxn_plot_df$pval_est < .1),]
